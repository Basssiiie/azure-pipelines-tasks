steps:

# Clean
- checkout: self
  clean: true

# Start collect diagnostics
- powershell: ./ci/start-collect-diagnostics.ps1
  displayName: Start collect diagnostics

# Use node 8, npm 5
- task: NodeTool@0
  displayName: Use node 8
  inputs:
    versionSpec: 8.x

# npm install
- script: npm install
  displayName: npm install

# Verify min agent demands
- script: |
    cd ci/verifyMinAgentDemands
    npm install
  displayName: npm install min agent demands

- script: node ./ci/verifyMinAgentDemands/index.js
  displayName: Verify min agent demands

# Build
- script: node make.js build --task "$(task)"
  displayName: Build

# Test
- script: node make.js test
  displayName: Run tests
- script: node make.js testLegacy --task "$(task)"
  displayName: Legacy tests with node 6

# Publish test results
- task: PublishTestResults@2
  displayName: Publish Test Results test-*.xml
  inputs:
    testResultsFiles: test-*.xml
    testRunTitle: Node 6 Test Results
    searchFolder: $(System.DefaultWorkingDirectory)/testresults

# Stage tasks individually into the package directory
- script: node ./ci/stage-package.js true individually
  displayName: Stage tasks individually into the package directory

# Sign task zip as nuget package
- template: sign-all-tasks.yml
  parameters:
    layoutRoot: $(Build.SourcesDirectory)\_package\tasks-layout

# Stage all the tasks into a single zip for upload
- script: node ./ci/stage-package.js true
  displayName: Stage all the tasks into a single zip for upload

# Publish hotfix artifact
- task: PublishBuildArtifacts@1
  displayName: Publish hotfix artifact
  inputs:
    pathToPublish: _package/hotfix-layout
    artifactName: hotfix
    publishLocation: container

# Stop collect diagnostics
- powershell: ./ci/stop-collect-diagnostics.ps1
  displayName: Stop collect diagnostics
